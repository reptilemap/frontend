<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reptilemap.world</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <style>
        #map { height: 450px; }
        body { background-color: #f8f8f8; }
        .hero-bg { background: linear-gradient(to right, #4CAF50, #8BC34A); }
    </style>

</head>
<body>

    <ul class="sidenav" id="mobile-demo">
        <li><a href="#about">About Us</a></li>
        <li><a href="#map-section">Map</a></li>
        <li><a href="#projects-section">Projects</a></li>
        <li><a href="#stories">Stories</a></li>
        <li><a href="#events">Events</a></li>
        <li><a href="#contact">Contact</a></li>
    </ul>

    <header>
        <nav id="home" class="light-green darken-4 z-depth-2">
            <div class="nav-wrapper container">
                <a href="#" class="brand-logo"><img src='logo.png'/></a>
                <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                <ul class="right hide-on-med-and-down">
                    <li><a href="#about">About Us</a></li>
                    <li><a href="#map-section">Map</a></li>
                    <li><a href="#projects-section">Projects</a></li>
                    <li><a href="#stories">Stories</a></li>
                    <li><a href="#events">Events</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </div>
        </nav>
    </header>

    <main>
        <section class="hero-bg white-text section no-pad-bot">
            <div class="container center-align">
                <br><br>
                <h1 id='main_title' class="header light-green-text text-lighten-5">A</h1>
                <div class="row center">
                    <h5 id='main_splash' class="header col s12 light"></h5>
                </div>
                <div class="row center">
                    <a href="#map-section" class="btn-large waves-effect waves-light white light-green-text text-darken-4">View Map</a>
                </div>
                <br><br>
            </div>
        </section>

        <section id="conference" class="section scrollspy">
            <div class="container center-align">
                <h2 id='c_title' class="light-green-text text-darken-4"></h2>
                <h4 id='c_date' class="light-gray-text lighten-4"></h4>
                <h4 id='c_location'></h4>
                <p id='c_desc' class="flow-text"></p>
                <h6 id='poster'></h6>
                <div class="row">
                    <div id='confstuff'></div>
                </div>
            </div>
        </section>

        <section id="youtube" class="section scrollspy">
            <div class = "col s12 m6">
                <div class="video-container">
                    <iframe id='video' width="80%" src="" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                </div>
            </div>
        </section>

        <section id="about" class="section scrollspy grey lighten-3">
            <div class="container">
                <div class="row">
                    <div class="col s12 center">
                        <h2 class="light-green-text text-darken-4">About Us</h2>
                        <div id='about_us' class='flow-text'></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="map-section" class="section scrollspy">
            <div class="container">
                <h2 class="light-green-text text-darken-4 center">Reptilemap</h2>
                <div class="card z-depth-2">
                    <div class="card-content">
                        <div id="map"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="obs" class="section scrollspy">
            <div class="container">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title light-green-text text-darken-4">Submit Observation</span>
                        <form id="observationForm">
                            <div class="row">
                                <div class="input-field col s12 m6">
                                    <input id="latitude" type="number" step="any" required>
                                    <label for="latitude">Latitude</label>
                                </div>
                                <div class="input-field col s12 m6">
                                    <input id="longitude" type="number" step="any" required>
                                    <label for="longitude">Longitude</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s12">
                                    <input id="species" type="text" required>
                                    <label for="species">Species</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s12">
                                    <input id="link" type="url">
                                    <label for="link">Link (URL)</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s12">
                                    <input id="image" type="url">
                                    <label for="image">Image (URL)</label>
                                </div>
                            </div>
                            <div class="row center">
                                <button type="submit" class="btn waves-effect waves-light light-green darken-4">
                                    Submit
                                    <i class="material-icons right">send</i>
                                </button>
                            </div>
                            <p class="center-align" id="statusMessage"></p>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section id="projects-section" class="section scrollspy grey lighten-3">
            <div class="container center-align">
                <h2 class="light-green-text text-darken-4">Our Projects</h2>
                <p id='prj_splash' class="flow-text"></p>
                <div class="row">
                    <div id='allprjs'></div>
                </div>
            </div>
        </section>

        <section id="stories" class="section scrollspy">
            <div class="container center-align">
                <h2 class="light-green-text text-darken-4">Stories</h2>
                <!-- stories-container div populated by code -->
                <div class="row" id="stories-container"></div>
            </div>
            <!-- pages div populated by code -->
            <div id='pages'></div>
        </section>

        <section id="events" class="section scrollspy grey lighten-3">
            <div class="container center-align">
                <h2 class="light-green-text text-darken-4">Events</h2>
                <p class="flow-text">
                    Join us for our upcoming workshops, webinars, and field trips designed to educate and engage reptile enthusiasts and conservationists.
                </p>
                <div class="row" id="events-container"></div>
            </div>
            <!-- events div populated by code -->
            <div id='epages'></div>
        </section>

        <section id="contact" class="section scrollspy">
 
            <div class="container center-align">
                <h2 class="light-green-text text-darken-4">Contact us</h2>
                <p class="flow-text">
                    Drop us a line. Tell us who you are and ask a question, leave a suggestion or ask us how to get involved in reptile conservation in your area.
                </p>
                
                <div class="center-align" style='margin-bottom: 30px;'> 
                    <div style='display: flex; align-items: center; gap: 8px; justify-content: center;'>
                        <i class="material-icons medium light-green-text text-darken-4">email</i>
                        <span style='font-size: 25px;' class="light-green-text text-darken-4">reptilemap@gmail.com</span>
                    </div>
                </div>
            </div>
            

        </section>

    </main>

    <footer class="page-footer light-green darken-4">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">Reptilemap.world</h5>
                    <p class="grey-text text-lighten-4">A global initiative for reptile conservation.</p>
                </div>
                <div class="col l4 offset-l2 s12">
                    <h5 class="white-text">Links</h5>
                    <ul>
                        <li><a class="grey-text text-lighten-3" href="#home">Home</a></li>
                        <li><a class="grey-text text-lighten-3" href="#map-section">Map</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright light-green darken-3">
            <div class="container">
                © 2025 The Reptile Map. All rights reserved.
            </div>
        </div>
    </footer>

    <!-- import javascript from Materialize CSS framework -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <!-- import javascript from Leaflet map framework -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        
        // The observation is managed dynamically
        let observations = [];
        let mapInstance = null;
        let markers = [];
        let clickedCoords = null; // Global variable for map coordinates

        // Data Google sheet published CSV, Middleware Google App
        const OBS_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSAI3iRgPCDrYWFgOV_8rbswRvu2W4pYg29OS4jIRvpDxX0kA2sLyPSVTC83whLf3JfArhKIr87jEK6/pub?gid=0&single=true&output=csv';
        const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycbxI8w2hYv41EsB2XC8jnE5qDp8APzYFzBgfoG6yZviA307C8w2VwG37i7bBCYRDIN0/exec';

        // Helper function to update map markers
        function updateMapMarkers(obs) {
            if (!mapInstance) return;

            // Remove existing markers
            markers.forEach(marker => mapInstance.removeLayer(marker));
            markers = [];

            // Add new markers
            obs.forEach(observation => {
                const { lat, lon, species, image } = observation;
                if (lat && lon) {
                    const marker = L.marker([lat, lon]).addTo(mapInstance);
                    marker.bindPopup(`<h5>${species}</h5><br><img src=${image} width='100%' />`).openPopup();
                    markers.push(marker);
                }
            });

            // Fit bounds to markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                mapInstance.fitBounds(group.getBounds());
            }
        }

        // Asynchronously fetch observations and initialize the map
        async function fetchObservations() {
            try {
                const response = await fetch(OBS_SHEET_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const csvText = await response.text();
                const lines = csvText.trim().split('\n').slice(1);
                
                observations = lines.map(line => {
                    const [lat, lon, species, link, image] = line.split(',').map(d => d.trim());
                    return { lat: parseFloat(lat), lon: parseFloat(lon), species, link, image };
                });

                updateMapMarkers(observations);

            } catch (error) {
                console.error("Failed to fetch observations:", error);
            }
        }

        // Initialize Map
        function initMap() {
            mapInstance = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(mapInstance);

            // Handle map click for setting coordinates in form
            mapInstance.on('click', (e) => {
                clickedCoords = { lat: e.latlng.lat, lng: e.latlng.lng };

                // Update the form fields manually
                document.getElementById('latitude').value = clickedCoords.lat.toFixed(4);
                document.getElementById('longitude').value = clickedCoords.lng.toFixed(4);
                M.updateTextFields(); // Required for Materialize to update input fields

                L.popup()
                    .setLatLng(e.latlng)
                    .setContent("Clicked at: " + e.latlng.toString())
                    .openOn(mapInstance);
            });

            fetchObservations(); // Load initial data
        }

        // Observation Form Submission
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('observationForm');
            const statusEl = document.getElementById('statusMessage');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();

                const formData = {
                    latitude: document.getElementById('latitude').value,
                    longitude: document.getElementById('longitude').value,
                    species: document.getElementById('species').value,
                    link: document.getElementById('link').value,
                    image: document.getElementById('image').value
                };

                statusEl.textContent = 'Submitting data...';
                statusEl.className = 'grey-text';

                try {
                    const response = await fetch(SUBMIT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    // Update local observations and map
                    observations.push({
                        lat: parseFloat(formData.latitude),
                        lon: parseFloat(formData.longitude),
                        species: formData.species,
                        link: formData.link,
                        image: formData.image
                    });
                    updateMapMarkers(observations);

                    statusEl.textContent = 'Data successfully submitted!';
                    statusEl.className = 'green-text';

                    // Reset form
                    form.reset();
                    M.updateTextFields();

                } catch (error) {
                    console.error('Error:', error);
                    statusEl.textContent = 'Error submitting data. Please try again.';
                    statusEl.className = 'red-text';
                }
            });

        });

        // Function to fetch the local blog JSON data
        async function fetchJsonData(filePath) {

          try {
            // 2. Use the 'fetch' API to make a network request.
            const response = await fetch(filePath);

            // 3. Check if the request was successful (status 200-299).
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            // 4. Use the .json() method to parse the response body as JSON.
            const data = await response.json();

            // 5. Do something with the fetched data
            console.log('Successfully fetched and parsed data:', data);

            // You can return the data or call another function with it
            renderIt(data,filePath);

          } catch (error) {
            // 6. Handle any errors that occurred during the fetch or parsing.
            console.error('There was a problem fetching the data:', error);
          }
        }

        // Call the function to start the fetch process, and then render
        files = ['events.json','blogs.json', 'init.json'];
        for (i=0;i<files.length;i++) {
          fetchJsonData(files[i]); // render Events and Stories
        }

        // Rendering static data from json files (Events and Stories)
        function renderIt(data,filePath) {
 
            let genericContainer = null;
            let genericPages = null;
            if (filePath == 'events.json') {
                genericContainer = document.getElementById('events-container');
                genericPages = document.getElementById('epages');
            } else if (filePath == 'blogs.json') {
                genericContainer = document.getElementById('stories-container');
                genericPages = document.getElementById('pages');
            } else {
                renderInit(data);
                return;
            }

            data.slice(0, 3).forEach((thing, index) => {
                const myHtml = `
                    <div class="col s12 m6 l4">
                        <div class="card medium">
                            <div class="card-image waves-effect waves-block waves-light">
                                <img class="activator" src="${thing.thumbnail}">
                            </div>
                            <div class="card-content">
                                <span class="card-title activator light-green-text text-darken-4">${thing.title}</span>
                                <p><a href="render.html?file=${filePath}&thing=${index}">Read More</a></p>
                            </div>
                        </div>
                    </div>
                `;
                genericContainer.insertAdjacentHTML('beforeend', myHtml);
                var myhtml = "<div class='row center'><ul class='pagination'>"
                data.forEach((thing, index) => {
                    myhtml = myhtml + "<li><a href='render.html?file=" + filePath + "&thing=" + index + "'>" + index + "</a></li>"
                });
                myhtml = myhtml + "</ul></div>"
                genericPages.innerHTML = myhtml;

            });
        }

        function renderInit(data) {
            let main_title = document.getElementById('main_title');
            let main_splash = document.getElementById('main_splash');
            let prj_splash = document.getElementById('prj_splash');
            main_title.innerHTML = data.general_settings.main_title;
            main_splash.innerHTML = data.general_settings.main_splash;
            prj_splash.innerHTML = data.general_settings.prj_splash;


            let allconf = document.getElementById('confstuff');
            myHtml = '';
            for (i=0;i<data.conference[0].sections.length;i++) {
                myHtml = myHtml + 
                `<div class="col s12 m6 l4">
                    <div class="card large light-green lighten-5">
                        <div class="card-content light-green-text text-darken-4">
                            <h4 class="card-title">${data.conference[0].sections[i].title}</h4>
                            <p>${data.conference[0].sections[i].description}</p>
                        </div>
                    </div>
                </div>`
                //allconf.insertAdjacentHTML('beforeend', myHtml);
                allconf.innerHTML = myHtml;
            }

            document.getElementById('c_title').innerHTML = data.conference[0].title;
            document.getElementById('c_date').innerHTML = data.conference[0].date;
            document.getElementById('c_location').innerHTML = data.conference[0].location;
            document.getElementById('c_desc').innerHTML = data.conference[0].description;
            document.getElementById('poster').innerHTML = "<a href='poster25.jpg' target='_blank'>Poster</a>";
            
            // Youtube
            let myiframe = document.getElementById('video');
            myiframe.src = data.videos[0].link;

            let allprjs = document.getElementById('allprjs');
            for (i=0;i<data.projects.length;i++) {
                myHtml = 
                `<div class="col s12 m6 l4">
                    <div class="card small light-green lighten-5">
                        <div class="card-content light-green-text text-darken-4">
                            <h4 class="card-title">${data.projects[i].title}</h4>
                            <p>${data.projects[i].description}</p>
                        </div>
                    </div>
                </div>`
                allprjs.insertAdjacentHTML('beforeend', myHtml);
            }

            let about_us = document.getElementById('about_us');
            for (i=0;i<data.about_us.length;i++) {
               myHtml = 
               `
                <p>${data.about_us[i].content}<p>
               ` 
               about_us.insertAdjacentHTML('beforeend', myHtml);
            }

        }

        // Initialization on DOM Load
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Materialize Components (Sidenav, Scrollspy, etc.)
            M.AutoInit(); 

            // Initialize the Map and fetch data
            initMap();

        });

    </script>

</body>
</html>